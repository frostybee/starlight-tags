---
/**
 * TagSidebar: A widget showing popular tags for navigation
 *
 * This component can be placed anywhere in your site - not just the sidebar.
 * Common placements include:
 * - Sidebar overrides
 * - Table of Contents (TOC) overrides
 * - MDX content pages
 * - Custom layouts
 *
 * @example Sidebar override (src/components/Sidebar.astro)
 * ```astro
 * ---
 * import Default from '@astrojs/starlight/components/Sidebar.astro';
 * import { TagSidebar } from 'starlight-tags/components';
 * ---
 * <Default {...Astro.props} />
 * <TagSidebar />
 * ```
 *
 * @example TOC override (src/components/TableOfContents.astro)
 * ```astro
 * ---
 * import Default from '@astrojs/starlight/components/TableOfContents.astro';
 * import { TagSidebar } from 'starlight-tags/components';
 * ---
 * <Default {...Astro.props} />
 * <TagSidebar title="Browse Tags" />
 * ```
 *
 * @example MDX page
 * ```mdx
 * import { TagSidebar } from 'starlight-tags/components';
 *
 * <TagSidebar limit={5} showCount={false} />
 * ```
 */
import { buildUrlFromCurrentPage } from '../libs/url.js';
import type { ProcessedTag } from '../schemas/tags.js';

interface Props {
  /** Maximum number of tags to display */
  limit?: number;
  /** Sort order for tags */
  sortBy?: 'count' | 'priority' | 'alphabetical';
  /** Show page count badge next to each tag */
  showCount?: boolean;
  /** Section heading */
  title?: string;
  /** Enable collapsible behavior */
  collapsible?: boolean;
  /** Start with sidebar collapsed (only used if collapsible is true) */
  collapsed?: boolean;
}

// Get translation function from Starlight's i18n system
const t = Astro.locals.t;

const {
  limit = 10,
  sortBy = 'count',
  showCount = true,
  title: titleProp,
  collapsible = true,
  collapsed = false
} = Astro.props;

// Apply translation as default after destructuring to ensure proper locale context
const title = titleProp ?? t('starlightTags.popularTags');

// Get tags from middleware-injected data
const tagsData = Astro.locals.starlightTags;
if (!tagsData) {
  throw new Error(
    '[starlight-tags] Tag data not available. ' +
    'Ensure the starlight-tags plugin is configured correctly in astro.config.mjs.'
  );
}
const { allTagsSorted } = tagsData;
let tags: ProcessedTag[] = allTagsSorted;

// Sort based on sortBy prop
if (sortBy === 'count') {
  tags = [...tags].sort((a, b) => b.count - a.count);
} else if (sortBy === 'alphabetical') {
  tags = [...tags].sort((a, b) => a.label.localeCompare(b.label));
}
// 'priority' uses default from getAllTagsSorted()

const popularTags = tags.slice(0, limit);
const tagsIndexUrl = buildUrlFromCurrentPage(`/${tagsData.config.tagsIndexSlug}/`, Astro.url);
---

{popularTags.length > 0 && (
  <nav
    class="sl-tag-sidebar"
    data-collapsible={collapsible}
    data-open={!collapsed}
    aria-label={title || 'Tags'}
  >
    {title && (
      <button
        type="button"
        class="sl-tag-sidebar__header"
        aria-expanded={!collapsed}
        aria-controls="sl-tag-sidebar-content"
        disabled={!collapsible}
      >
        <span class="sl-tag-sidebar__title">{title}</span>
        {collapsible && (
          <svg
            class="sl-tag-sidebar__chevron"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        )}
      </button>
    )}
    <div class="sl-tag-sidebar__content" id="sl-tag-sidebar-content">
      <ul class="sl-tag-sidebar__list">
        {popularTags.map(tag => (
          <li>
            <a href={buildUrlFromCurrentPage(tag.url, Astro.url)} class="sl-tag-sidebar__item">
              <span class="sl-tag-sidebar__name">{tag.label}</span>
              {showCount && (
                <span class="sl-tag-sidebar__count" aria-label={`${tag.count} pages`}>{tag.count}</span>
              )}
            </a>
          </li>
        ))}
      </ul>
      <a href={tagsIndexUrl} class="sl-tag-sidebar__all">
        {t('starlightTags.viewAllTags')}<span aria-hidden="true"> &rarr;</span>
      </a>
    </div>
  </nav>
)}

<!-- Inline script to prevent hydration flash - runs before first paint -->
<script is:inline>
  (function() {
    var STORAGE_KEY = 'starlight-tag-sidebar-open';
    var savedState = localStorage.getItem(STORAGE_KEY);
    if (savedState !== null) {
      var isOpen = savedState === 'true';
      document.querySelectorAll('.sl-tag-sidebar[data-collapsible="true"]').forEach(function(el, index) {
        // Disable transitions during initial state restore
        el.style.setProperty('--_transition', 'none');
        el.dataset.open = String(isOpen);
        var header = el.querySelector('.sl-tag-sidebar__header');
        var content = el.querySelector('.sl-tag-sidebar__content');
        if (header) {
          header.setAttribute('aria-expanded', String(isOpen));
        }
        // Re-enable transitions after a frame
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            el.style.removeProperty('--_transition');
          });
        });
      });
    }
  })();
</script>

<script>
  class TagSidebarToggle {
    private static STORAGE_KEY = 'starlight-tag-sidebar-open';
    private static instanceCounter = 0;

    static init() {
      const sidebars = document.querySelectorAll<HTMLElement>('.sl-tag-sidebar[data-collapsible="true"]');

      sidebars.forEach((sidebar, index) => {
        const header = sidebar.querySelector<HTMLButtonElement>('.sl-tag-sidebar__header');
        const content = sidebar.querySelector<HTMLElement>('.sl-tag-sidebar__content');
        if (!header || !content) return;

        // Generate unique IDs for aria-controls relationship
        const uniqueId = `sl-tag-sidebar-content-${this.instanceCounter++}`;
        content.id = uniqueId;
        header.setAttribute('aria-controls', uniqueId);

        // Remove any existing listeners (for SPA navigation)
        const newHeader = header.cloneNode(true) as HTMLButtonElement;
        header.parentNode?.replaceChild(newHeader, header);

        newHeader.addEventListener('click', () => {
          const isOpen = sidebar.dataset.open === 'true';
          const newState = !isOpen;

          sidebar.dataset.open = String(newState);
          newHeader.setAttribute('aria-expanded', String(newState));
          localStorage.setItem(this.STORAGE_KEY, String(newState));
        });
      });
    }
  }

  // Initialize on page load and after Astro page transitions
  TagSidebarToggle.init();
  document.addEventListener('astro:after-swap', () => TagSidebarToggle.init());
</script>

<style>
  .sl-tag-sidebar {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
  }

  .sl-tag-sidebar__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0;
    margin: 0 0 0.75rem 0;
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
  }

  .sl-tag-sidebar__header:disabled {
    cursor: default;
  }

  .sl-tag-sidebar[data-collapsible="true"] .sl-tag-sidebar__header:hover {
    opacity: 0.8;
  }

  .sl-tag-sidebar__title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .sl-tag-sidebar__chevron {
    color: var(--sl-color-gray-3);
    transition: var(--_transition, transform 0.2s ease);
  }

  .sl-tag-sidebar[data-open="false"] .sl-tag-sidebar__chevron {
    transform: rotate(-90deg);
  }

  .sl-tag-sidebar__content {
    display: grid;
    grid-template-rows: 1fr;
    transition: var(--_transition, grid-template-rows 0.2s ease);
  }

  .sl-tag-sidebar[data-open="false"] .sl-tag-sidebar__content {
    grid-template-rows: 0fr;
  }

  .sl-tag-sidebar[data-open="false"] .sl-tag-sidebar__content > * {
    overflow: hidden;
  }

  .sl-tag-sidebar[data-open="false"] .sl-tag-sidebar__header {
    margin-bottom: 0;
  }

  .sl-tag-sidebar__list {
    list-style: none;
    margin: 0 0 1rem 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .sl-tag-sidebar__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.375rem 0;
    color: var(--sl-color-gray-2);
    text-decoration: none;
    border-bottom: 1px solid var(--sl-color-gray-6);
    transition: color 0.15s ease;
  }

  .sl-tag-sidebar__item:hover {
    color: var(--sl-color-accent);
  }

  .sl-tag-sidebar__list li:last-child .sl-tag-sidebar__item {
    border-bottom: none;
  }

  .sl-tag-sidebar__name {
    font-size: var(--sl-text-sm);
  }

  .sl-tag-sidebar__count {
    font-size: 0.75rem;
    background: var(--sl-color-gray-5);
    color: var(--sl-color-white);
    padding: 0.125rem 0.5rem;
    border-radius: 1rem;
    min-width: 1.5rem;
    text-align: center;
  }

  .sl-tag-sidebar__all {
    display: inline-block;
    color: var(--sl-color-accent);
    text-decoration: none;
    font-size: var(--sl-text-sm);
    font-weight: 500;
  }

  .sl-tag-sidebar__all:hover {
    text-decoration: underline;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .sl-tag-sidebar__chevron,
    .sl-tag-sidebar__content {
      transition: none;
    }
  }
</style>
