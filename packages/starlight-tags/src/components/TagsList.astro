---
/**
 * TagsList: Displays a collection of tags with customizable layouts
 *
 * Usage in MDX:
 * ```mdx
 * import { TagsList } from 'starlight-tags/components';
 *
 * <!-- Show all tags -->
 * <TagsList />
 *
 * <!-- Show specific tags -->
 * <TagsList tagIds={['auth', 'api', 'webhooks']} />
 *
 * <!-- With options -->
 * <TagsList limit={6} layout="grid" showCount variant="outline" />
 * ```
 *
 * Or with pre-fetched tags (for internal use):
 * ```astro
 * <TagsList tags={processedTags} />
 * ```
 */
import TagBadge from './TagBadge.astro';
import type { ProcessedTag } from '../schemas/tags.js';

interface Props {
  /** Specific tag IDs to display */
  tagIds?: string[];
  /** Pre-fetched tag objects (for internal/advanced use) */
  tags?: ProcessedTag[];
  /** Maximum number of tags to show */
  limit?: number;
  /** Optional heading above tags */
  title?: string | undefined;
  showCount?: boolean;
  layout?: 'inline' | 'grid' | 'list';
  variant?: 'solid' | 'outline' | 'ghost';
  sortBy?: 'name' | 'count';
}

const {
  tagIds,
  tags: tagsProp,
  limit,
  title,
  showCount = false,
  layout = 'inline',
  variant = 'solid',
  sortBy = 'name'
} = Astro.props;

// Get tags from middleware-injected data
const { tags: tagsMap, allTagsSorted } = Astro.locals.starlightTags;

// Resolve tags: use provided tags, fetch by IDs, or get all
let resolvedTags: ProcessedTag[] = tagsProp || [];

if (!tagsProp) {
  if (tagIds && tagIds.length > 0) {
    // Fetch specific tags by ID
    resolvedTags = tagIds
      .map(id => tagsMap.get(id))
      .filter((t): t is ProcessedTag => t !== undefined);
  } else {
    // Get all tags
    resolvedTags = allTagsSorted;
  }
}

// Sort tags based on sortBy prop
let sortedTags = [...resolvedTags].sort((a, b) => {
  if (sortBy === 'count') {
    return b.count - a.count || a.label.localeCompare(b.label);
  }
  // Default: sort by name
  return a.label.localeCompare(b.label);
});

// Apply limit after sorting
if (limit && limit > 0) {
  sortedTags = sortedTags.slice(0, limit);
}
---

{title && <h3 class="fb-tags-list__title" id="tags-list-title">{title}</h3>}

<ul
  class:list={['fb-tags-list', `fb-tags-list--${layout}`]}
  aria-label={title ? undefined : 'Tags'}
  aria-labelledby={title ? 'tags-list-title' : undefined}
  role="list"
>
  {sortedTags.map(tag => (
    <li class="fb-tags-list__item">
      <TagBadge
        tag={tag}
        showCount={showCount}
        variant={variant}
      />
    </li>
  ))}
</ul>

<style>
  .fb-tags-list__title {
    margin-bottom: 1rem;
    font-size: var(--sl-text-lg);
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .fb-tags-list {
    list-style: none;
    margin: 0;
    padding: 0;

    /* Inline layout (default) */
    &.fb-tags-list--inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Grid layout */
    &.fb-tags-list--grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    /* List layout */
    &.fb-tags-list--list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
  }

  .fb-tags-list__item {
    display: contents;
  }
</style>
