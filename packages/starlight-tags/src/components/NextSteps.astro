---
import type { ProcessedTag } from '../schemas/tags.js';
import TagBadge from './TagBadge.astro';

interface Props {
  tag: ProcessedTag;
  tagsMap: Map<string, ProcessedTag>;
  showDescription?: boolean;
  maxSteps?: number;
  showEstimatedTime?: boolean;
}

const { 
  tag, 
  tagsMap, 
  showDescription = true, 
  maxSteps = 6,
  showEstimatedTime = true
} = Astro.props;

// Get next steps with tag objects
const nextSteps = (tag.nextSteps || [])
  .slice(0, maxSteps)
  .map(tagId => tagsMap.get(tagId))
  .filter(Boolean) as ProcessedTag[];

const hasNextSteps = nextSteps.length > 0;

// Group next steps by difficulty or content type
const groupedSteps = nextSteps.reduce((groups, step) => {
  const key = step.difficulty || step.contentType || 'other';
  if (!groups[key]) groups[key] = [];
  groups[key].push(step);
  return groups;
}, {} as Record<string, ProcessedTag[]>);

const totalEstimatedTime = nextSteps
  .filter(step => step.estimatedTime)
  .reduce((total, step) => total + (step.estimatedTime || 0), 0);
---

{hasNextSteps && (
  <div class="next-steps">
    <div class="next-steps__header">
      <h4 class="next-steps__title">
        üéØ What's Next?
      </h4>
      {showDescription && (
        <p class="next-steps__description">
          Recommended topics to continue your learning journey
        </p>
      )}
      {showEstimatedTime && totalEstimatedTime > 0 && (
        <p class="next-steps__time">
          ‚è±Ô∏è Estimated time: {Math.round(totalEstimatedTime / 60)}h {totalEstimatedTime % 60}m
        </p>
      )}
    </div>
    
    <div class="next-steps__content">
      {Object.entries(groupedSteps).map(([groupKey, steps]) => (
        <div class="next-steps__group" key={groupKey}>
          {Object.keys(groupedSteps).length > 1 && (
            <h5 class="next-steps__group-title">
              {groupKey === 'beginner' && 'üå± Beginner Level'}
              {groupKey === 'intermediate' && 'üåø Intermediate Level'}  
              {groupKey === 'advanced' && 'üå≥ Advanced Level'}
              {groupKey === 'lecture' && 'üìñ Lectures'}
              {groupKey === 'tutorial' && 'üíª Tutorials'}
              {groupKey === 'exercise' && '‚úèÔ∏è Exercises'}
              {groupKey === 'reference' && 'üìö References'}
              {groupKey === 'assessment' && 'üìù Assessments'}
              {groupKey === 'other' && 'üìå Recommended'}
            </h5>
          )}
          
          <div class="next-steps__items">
            {steps.map((nextStep) => (
              <div class="next-steps__item" key={nextStep.id}>
                <div class="next-steps__item-main">
                  <TagBadge 
                    tag={nextStep} 
                    size="medium" 
                    variant="ghost"
                    showCount={false}
                  />
                  {nextStep.estimatedTime && showEstimatedTime && (
                    <span class="next-steps__item-time">
                      {nextStep.estimatedTime}min
                    </span>
                  )}
                </div>
                {nextStep.description && (
                  <p class="next-steps__item-description">
                    {nextStep.description}
                  </p>
                )}
                {nextStep.skillLevel && (
                  <div class="next-steps__item-skill">
                    <span class="next-steps__skill-label">Skill Level:</span>
                    <div class="next-steps__skill-bar">
                      {Array.from({ length: 10 }, (_, i) => (
                        <div 
                          class={`next-steps__skill-dot ${i < nextStep.skillLevel ? 'active' : ''}`}
                          key={i}
                        />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      ))}
      
      {tag.nextSteps && tag.nextSteps.length > maxSteps && (
        <div class="next-steps__more">
          <p class="next-steps__more-text">
            ... and {tag.nextSteps.length - maxSteps} more learning opportunities
          </p>
        </div>
      )}
    </div>
  </div>
)}

<style>
  .next-steps {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: var(--sl-border-radius);
    padding: 1rem;
    margin: 1rem 0;
  }
  
  .next-steps__header {
    margin-bottom: 1rem;
  }
  
  .next-steps__title {
    margin: 0 0 0.25rem 0;
    font-size: var(--sl-text-base);
    font-weight: 600;
    color: var(--sl-color-text);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .next-steps__description {
    margin: 0 0 0.5rem 0;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-text-accent);
    line-height: 1.4;
  }
  
  .next-steps__time {
    margin: 0;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-accent);
    font-weight: 500;
  }
  
  .next-steps__content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .next-steps__group-title {
    margin: 0 0 0.5rem 0;
    font-size: var(--sl-text-sm);
    font-weight: 600;
    color: var(--sl-color-text-accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .next-steps__items {
    display: grid;
    gap: 0.75rem;
  }
  
  .next-steps__item {
    padding: 0.75rem;
    background: var(--sl-color-bg);
    border: 1px solid var(--sl-color-hairline-shade);
    border-radius: var(--sl-border-radius);
    transition: all 0.2s ease;
  }
  
  .next-steps__item:hover {
    border-color: var(--sl-color-accent-light);
    box-shadow: 0 2px 8px color-mix(in srgb, var(--sl-color-accent) 10%, transparent);
  }
  
  .next-steps__item-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .next-steps__item-time {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-text-accent);
    background: var(--sl-color-bg-sidebar);
    padding: 0.125rem 0.375rem;
    border-radius: var(--sl-border-radius);
    font-weight: 500;
  }
  
  .next-steps__item-description {
    margin: 0 0 0.5rem 0;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-text-accent);
    line-height: 1.4;
  }
  
  .next-steps__item-skill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .next-steps__skill-label {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-text-accent);
    font-weight: 500;
  }
  
  .next-steps__skill-bar {
    display: flex;
    gap: 0.125rem;
  }
  
  .next-steps__skill-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-hairline-shade);
    transition: all 0.2s ease;
  }
  
  .next-steps__skill-dot.active {
    background: var(--sl-color-accent);
    border-color: var(--sl-color-accent);
  }
  
  .next-steps__more {
    text-align: center;
    padding: 0.75rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: var(--sl-border-radius);
  }
  
  .next-steps__more-text {
    margin: 0;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-text-accent);
    font-style: italic;
  }
  
  @media (min-width: 768px) {
    .next-steps__items {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
  }
</style>