---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import TagsList from '../components/TagsList.astro';
import { initTags, getAllTagsSorted } from 'virtual:starlight-tagging/tags';
import { buildUrl } from '../libs/url.js';
import { createTierCalculator } from '../libs/popularity.js';
// @ts-expect-error - virtual module provided by Starlight
import starlightConfig from 'virtual:starlight/user-config';

// Generate static paths for all supported locales
export function getStaticPaths() {
  const configuredLocales = starlightConfig.locales
    ? Object.keys(starlightConfig.locales).filter(l => l !== 'root')
    : [];

  return [
    { params: { locale: undefined } },
    ...configuredLocales.map(locale => ({
      params: { locale }
    }))
  ];
}

await initTags();

const allTags = getAllTagsSorted().filter(tag => !tag.hidden);
const totalTagUsages = allTags.reduce((sum, tag) => sum + tag.count, 0);
const t = Astro.locals.t;
const { locale } = Astro.params;

const maxCount = Math.max(...allTags.map(tag => tag.count), 1);
const minCount = Math.min(...allTags.map(tag => tag.count), 1);
const getPopularityTier = createTierCalculator(minCount, maxCount);

const tagsByLetter = allTags.reduce((acc, tag) => {
  const letter = tag.label.charAt(0).toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(tag);
  return acc;
}, {} as Record<string, typeof allTags>);

const sortedLetters = Object.keys(tagsByLetter).sort();
---

<StarlightPage
  frontmatter={{
    title: t('starlightTags.allTags'),
    description: `Browse all ${allTags.length} tags applied ${totalTagUsages} times across documentation pages.`,
    sidebar: {
      label: "Tags",
      order: 999
    }
  }}
  hasSidebar={true}
>
  <div class="tags-index">
    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <span class="stat-value">{allTags.length}</span>
        <span class="stat-label">{t('starlightTags.totalTags')}</span>
      </div>
      <span class="stat-separator">/</span>
      <div class="stat">
        <span class="stat-value">{totalTagUsages}</span>
        <span class="stat-label">{t('starlightTags.tagsApplied')}</span>
      </div>
    </div>

    <!-- Tag Cloud -->
    <section class="section">
      <h2 class="section-title">{t('starlightTags.tagCloud')}</h2>
      <div class="cloud">
        {allTags.map(tag => (
          <a
            href={buildUrl(tag.url, locale)}
            class={`cloud-tag ${getPopularityTier(tag.count)}`}
            title={`${tag.count} ${tag.count === 1 ? t('starlightTags.page') : t('starlightTags.pages')}`}
          >
            {tag.icon && <span class="icon">{tag.icon}</span>}
            <span>{tag.label}</span>
            <span class="count">{tag.count}</span>
          </a>
        ))}
      </div>
    </section>

    <!-- Alphabetical Index -->
    <section class="section">
      <h2 class="section-title">{t('starlightTags.alphabeticalIndex')}</h2>

      <nav class="letter-nav" aria-label="Jump to letter">
        {sortedLetters.map(letter => (
          <a href={`#letter-${letter}`} class="letter-link">{letter}</a>
        ))}
      </nav>

      <div class="index">
        {sortedLetters.map(letter => (
          <div class="letter-section" id={`letter-${letter}`}>
            <div class="letter-header">
              <span class="letter">{letter}</span>
              <span class="letter-line"></span>
              <span class="letter-count">{tagsByLetter[letter].length}</span>
            </div>

            <div class="cards">
              {tagsByLetter[letter].map(tag => (
                <a href={buildUrl(tag.url, locale)} class={`card ${getPopularityTier(tag.count)}`}>
                  <div class="card-main">
                    <span class="card-name">
                      {tag.icon && <span class="icon">{tag.icon}</span>}
                      {tag.label}
                    </span>
                    <span class="card-count">{tag.count}</span>
                  </div>
                  {tag.description && (
                    <p class="card-desc">{tag.description}</p>
                  )}
                  <div class="card-bar">
                    <div class="card-bar-fill" style={`--w: ${(tag.count / maxCount) * 100}%`}></div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  </div>
</StarlightPage>

<style>
  .tags-index {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  /* ===== Stats ===== */
  .stats {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 1.5rem;
    padding: 2rem 0;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
    color: var(--sl-color-white);
    letter-spacing: -0.02em;
  }

  .stat-label {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sl-color-gray-3);
  }

  .stat-separator {
    font-size: 1.5rem;
    font-weight: 300;
    color: var(--sl-color-gray-4);
    margin-bottom: 1rem;
  }

  /* ===== Sections ===== */
  .section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .section-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--sl-color-gray-3);
    margin: 0;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--sl-color-hairline);
  }

  /* ===== Tag Cloud ===== */
  .cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .cloud-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    font-weight: 500;
    color: var(--sl-color-text);
    text-decoration: none;
    border: 1px solid var(--sl-color-hairline);
    border-radius: 0.375rem;
    transition: border-color 0.15s, background-color 0.15s;
  }

  .cloud-tag:hover {
    border-color: var(--sl-color-accent);
    background: var(--sl-color-accent-low);
  }

  .cloud-tag:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .cloud-tag .count {
    font-size: 0.7em;
    font-weight: 600;
    color: var(--sl-color-gray-3);
    padding: 0.1em 0.4em;
    background: var(--sl-color-gray-6);
    border-radius: 0.25rem;
  }

  .cloud-tag.tier-1 { font-size: 0.8rem; }
  .cloud-tag.tier-2 { font-size: 0.875rem; }
  .cloud-tag.tier-3 { font-size: 0.95rem; }
  .cloud-tag.tier-4 { font-size: 1.05rem; font-weight: 600; }
  .cloud-tag.tier-5 { font-size: 1.15rem; font-weight: 600; }

  .icon {
    font-style: normal;
    line-height: 1;
  }

  /* ===== Letter Navigation ===== */
  .letter-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    padding: 1rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: 0.75rem;
    border: 1px solid var(--sl-color-hairline);
  }

  .letter-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--sl-color-text);
    background: var(--sl-color-bg-nav);
    border-radius: 0.5rem;
    border: 1px solid var(--sl-color-hairline);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .letter-link:hover {
    border-color: var(--sl-color-accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .letter-link:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  /* ===== Index ===== */
  .index {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .letter-section {
    scroll-margin-top: 2rem;
  }

  .letter-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .letter {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--sl-color-white);
  }

  .letter-line {
    flex: 1;
    height: 1px;
    background: var(--sl-color-hairline);
  }

  .letter-count {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--sl-color-gray-4);
    font-variant-numeric: tabular-nums;
  }

  /* ===== Cards ===== */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 0.75rem;
  }

  .card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    text-decoration: none;
    color: var(--sl-color-text);
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline);
    border-radius: 0.5rem;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .card:hover {
    border-color: var(--sl-color-gray-4);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .card:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .card-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .card-name {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .card-count {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--sl-color-gray-3);
    font-variant-numeric: tabular-nums;
  }

  .card-desc {
    font-size: 0.8rem;
    color: var(--sl-color-gray-2);
    line-height: 1.5;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-bar {
    height: 2px;
    background: var(--sl-color-gray-6);
    border-radius: 1px;
    margin-top: auto;
    overflow: hidden;
  }

  .card-bar-fill {
    width: var(--w);
    height: 100%;
    background: var(--sl-color-accent);
    border-radius: inherit;
  }

  /* Tier accents on cards */
  .card.tier-4 .card-bar-fill,
  .card.tier-5 .card-bar-fill {
    background: linear-gradient(90deg, var(--sl-color-accent), var(--sl-color-accent-high));
  }

  /* ===== Responsive ===== */
  @media (max-width: 640px) {
    .tags-index {
      gap: 2rem;
    }

    .stats {
      gap: 1rem;
      padding: 1.5rem 0;
    }

    .stat-value {
      font-size: 2.25rem;
    }

    .cards {
      grid-template-columns: 1fr;
    }

    .letter-nav {
      gap: 0.35rem;
    }

    .letter-link {
      width: 2rem;
      height: 2rem;
      font-size: 0.8rem;
    }
  }

  /* ===== Light Mode ===== */
  :global([data-theme='light']) .letter-nav {
    background: var(--sl-color-gray-6);
  }

  :global([data-theme='light']) .letter-link {
    background: white;
  }

  /* ===== Dark Mode ===== */
  :global([data-theme='dark']) .letter-nav {
    background: rgba(30, 30, 40, 0.6);
  }

  :global([data-theme='dark']) .letter-link {
    background: rgba(45, 45, 60, 0.8);
  }

  /* ===== Accessibility ===== */
  @media (prefers-reduced-motion: reduce) {
    .cloud-tag,
    .letter-link,
    .card {
      transition: none;
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }
</style>
