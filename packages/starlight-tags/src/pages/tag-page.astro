---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import TagBadge from '../components/TagBadge.astro';
import TagPagination from '../components/TagPagination.astro';
import { initTags, getAllTagsSorted, getTag } from 'virtual:starlight-tagging/tags';
// @ts-expect-error - virtual module provided by plugin
import { config } from 'virtual:starlight-tagging/config';
import { buildUrl } from '../libs/url.js';
import { calculatePagination, paginateArray, type PaginationInfo } from '../libs/pagination.js';
import type { ProcessedTag, PageReference } from '../schemas/tags.js';
import { createTierCalculator } from '../libs/popularity.js';
// @ts-expect-error - virtual module provided by Starlight
import starlightConfig from 'virtual:starlight/user-config';

interface Props {
  tag: ProcessedTag;
  pages: PageReference[];
  pagination: PaginationInfo;
}

export async function getStaticPaths() {
  // Initialize tags store (memoized - only runs once)
  await initTags();

  const tags = getAllTagsSorted();
  const itemsPerPage = config.itemsPerPage;

  // Get configured locales from Starlight config (not plugin translations)
  // If no locales configured, only generate root paths
  const configuredLocales = starlightConfig.locales
    ? Object.keys(starlightConfig.locales).filter(l => l !== 'root')
    : [];

  // Pre-calculate total path count to avoid array resizing during iteration
  // Formula: sum of (pages_per_tag * (1 + non_root_locales)) for each tag
  const localeMultiplier = 1 + configuredLocales.length;
  let totalPathCount = 0;
  for (const tag of tags) {
    const totalPages = Math.max(1, Math.ceil(tag.pages.length / itemsPerPage));
    totalPathCount += totalPages * localeMultiplier;
  }

  // Pre-allocate array with known size for memory efficiency
  const paths: Array<{
    params: { tag: string; locale: string | undefined; page: string | undefined };
    props: Props;
  }> = new Array(totalPathCount);

  let pathIndex = 0;

  for (const tag of tags) {
    const totalPages = Math.max(1, Math.ceil(tag.pages.length / itemsPerPage));

    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      const pagination = calculatePagination(tag.pages.length, pageNum, itemsPerPage);
      const paginatedPages = paginateArray(tag.pages, pagination);
      const pageParam = pageNum === 1 ? undefined : String(pageNum);

      // Root path (no locale prefix - for default/root locale)
      paths[pathIndex++] = {
        params: {
          tag: tag.slug,
          locale: undefined,
          page: pageParam
        },
        props: { tag, pages: paginatedPages, pagination }
      };

      // Locale-prefixed paths (only if i18n is configured)
      for (const locale of configuredLocales) {
        paths[pathIndex++] = {
          params: {
            tag: tag.slug,
            locale,
            page: pageParam
          },
          props: { tag, pages: paginatedPages, pagination }
        };
      }
    }
  }

  return paths;
}

const { tag, pages, pagination } = Astro.props;

// Guard against missing tag data (shouldn't happen, but ensures type safety)
if (!tag) {
  throw new Error('[starlight-tags] Tag data not found in props');
}

// Access translations via Astro.locals.t
const t = Astro.locals.t;

// Get locale from params for building URLs
// In Astro's [...param] rest routes, the param is string | undefined (not an array)
const { locale } = Astro.params as { locale?: string };

// Initialize tags store (memoized - already initialized in getStaticPaths, this is a no-op)
await initTags();

// Find related tags from the pages that have this tag
const relatedTags = new Set<string>();

for (const page of pages) {
  // Use tags from the page data (already available from the processor)
  const pageTags = page.tags;
  if (pageTags && Array.isArray(pageTags)) {
    for (const tagId of pageTags) {
      if (tagId !== tag.id) {
        relatedTags.add(tagId);
      }
    }
  }
}

const relatedTagsData = Array.from(relatedTags)
  .map(tagId => getTag(tagId))
  .filter((relTag): relTag is NonNullable<typeof relTag> => relTag !== undefined && !relTag.hidden)
  .sort((a, b) => b.count - a.count);

// Calculate popularity tiers for related tags
const maxRelatedCount = Math.max(...relatedTagsData.map(t => t.count), 1);
const minRelatedCount = Math.min(...relatedTagsData.map(t => t.count), 1);
const getPopularityTier = createTierCalculator(minRelatedCount, maxRelatedCount);
---

<StarlightPage
  frontmatter={{
    title: `${t('starlightTags.taggedPrefix')} ${tag.label}`,
    description: tag.description || `${pages.length} ${pages.length === 1 ? t('starlightTags.page') : t('starlightTags.pages')}`,
    sidebar: {
      label: tag.label,
      order: 999
    }
  }}
  hasSidebar={true}
>
  <div class="tag-page">
    <!-- Back to Tags Link -->
    <a href={buildUrl(`/${config.tagsPagesPrefix}/`, locale)} class="back-to-tags">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      {t('starlightTags.allTags')}
    </a>

    <!-- Tag Header Card -->
    <header class="tag-header">
      <div class="tag-header-content">
        <TagBadge tag={tag} size="large" clickable={false} />
        <div class="tag-stats">
          <div class="stat-pill">
            <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
            <span class="stat-number">{pagination.totalItems}</span>
            <span class="stat-label">{pagination.totalItems === 1 ? t('starlightTags.page') : t('starlightTags.pages')}</span>
          </div>
          {relatedTagsData.length > 0 && (
            <div class="stat-pill">
              <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
              <span class="stat-number">{relatedTagsData.length}</span>
              <span class="stat-label">{t('starlightTags.related')}</span>
            </div>
          )}
        </div>
        {tag.description && (
          <p class="tag-description">{tag.description}</p>
        )}
      </div>
    </header>

    <!-- Related Tags Section -->
    {relatedTagsData.length > 0 && (
      <aside class="related-tags">
        <h2 class="section-title">
          <svg class="title-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
          {t('starlightTags.relatedTags')}
        </h2>
        <div class="related-tags-cloud">
          {relatedTagsData.map(relatedTag => (
            <a
              href={buildUrl(relatedTag.url, locale)}
              class={`cloud-tag ${getPopularityTier(relatedTag.count)}`}
              title={`${relatedTag.label}: ${relatedTag.count} ${relatedTag.count === 1 ? t('starlightTags.page') : t('starlightTags.pages')}`}
            >
              {relatedTag.icon && <span class="tag-icon">{relatedTag.icon}</span>}
              <span class="tag-name">{relatedTag.label}</span>
              <span class="tag-badge">{relatedTag.count}</span>
            </a>
          ))}
        </div>
      </aside>
    )}

    <!-- Pages Section -->
    <section class="tagged-pages">
      <h2 class="section-title">
        <svg class="title-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        {t('starlightTags.pagesWithTag')}
      </h2>
      <div class="pages-grid">
        {pages.map((page, index) => (
          <a href={buildUrl(`/${page.slug || page.id}/`, locale)} class="page-card">
            <div class="page-card-header">
              <h3 class="page-card-title">{page.title}</h3>
              <span class="page-card-index">{pagination.startIndex + index + 1}</span>
            </div>
            {page.description && (
              <p class="page-card-description">{page.description}</p>
            )}
            <div class="page-card-footer">
              <span class="page-card-slug"><span class="slug-label">{t('starlightTags.path')}</span> /{page.slug || page.id}/</span>
              <svg class="page-card-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </div>
          </a>
        ))}
      </div>

      {/* Pagination */}
      <TagPagination
        pagination={pagination}
        tagSlug={tag.slug}
        tagsPagesPrefix={config.tagsPagesPrefix}
        locale={locale}
      />
    </section>
  </div>
</StarlightPage>

<style>
  /* ===== Base Container ===== */
  .tag-page {
    container-type: inline-size;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* ===== Back to Tags Link ===== */
  .back-to-tags {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--sl-text-sm);
    font-weight: 500;
    color: var(--sl-color-gray-2);
    text-decoration: none;
    transition: color 0.2s ease;
    width: fit-content;
  }

  .back-to-tags:hover {
    color: var(--sl-color-accent);
    text-decoration: none;
  }

  .back-to-tags svg {
    transition: transform 0.2s ease;
  }

  .back-to-tags:hover svg {
    transform: translateX(-3px);
  }

  /* ===== Tag Header Card ===== */
  .tag-header {
    background: var(--sl-color-bg-nav);
    border-radius: 0.75rem;
    border: 1px solid var(--sl-color-hairline);
    padding: 1rem 1.25rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .tag-header-content {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .tag-description {
    flex-basis: 100%;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-2);
    line-height: 1.5;
    margin: 0;
    padding-top: 0.5rem;
    border-top: 1px solid var(--sl-color-hairline);
  }

  .tag-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-left: auto;
  }

  .stat-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.75rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: 2rem;
    border: 1px solid var(--sl-color-hairline);
  }

  .stat-icon {
    width: 0.85rem;
    height: 0.85rem;
    flex-shrink: 0;
    color: var(--sl-color-gray-3);
  }

  .stat-number {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--sl-color-accent);
  }

  .stat-label {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
  }

  /* ===== Section Titles ===== */
  .section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--sl-color-white);
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--sl-color-hairline);
  }

  .title-icon {
    width: 1.25rem;
    height: 1.25rem;
    opacity: 0.7;
    flex-shrink: 0;
  }

  /* ===== Pages Section ===== */
  .tagged-pages {
    padding: 1.25rem;
    background: var(--sl-color-bg-nav);
    border-radius: 0.75rem;
    border: 1px solid var(--sl-color-hairline);
  }

  .pages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  /* Page Cards - matching tag-card style */
  .page-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: 0.75rem;
    border: 1px solid var(--sl-color-hairline);
    text-decoration: none !important;
    color: var(--sl-color-text);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
  }

  .page-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--sl-color-accent);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .page-card:hover {
    transform: translateY(-4px) translateX(2px);
    box-shadow:
      0 12px 24px -8px rgba(0, 0, 0, 0.15),
      0 4px 8px -2px rgba(0, 0, 0, 0.1);
    border-color: var(--sl-color-accent);
    text-decoration: none !important;
  }

  .page-card:hover::before {
    opacity: 1;
  }

  .page-card:focus {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .page-card:active {
    transform: translateY(-2px) translateX(1px);
  }

  .page-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .page-card-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--sl-color-white);
    transition: color 0.2s ease;
    flex: 1;
    min-width: 0;
  }

  .page-card:hover .page-card-title {
    color: var(--sl-color-accent);
  }

  .page-card-index {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.75rem;
    padding: 0.2rem 0.6rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--sl-color-accent);
    color: white;
    border-radius: 1rem;
    flex-shrink: 0;
  }

  .page-card-description {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-2);
    line-height: 1.5;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .page-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 0.5rem;
    border-top: 1px solid var(--sl-color-hairline);
  }

  .page-card-slug {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    font-family: var(--sl-font-mono);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .slug-label {
    font-family: var(--sl-font);
    font-weight: 500;
    color: var(--sl-color-gray-4);
  }

  .page-card-arrow {
    width: 1rem;
    height: 1rem;
    color: var(--sl-color-gray-4);
    transition: all 0.2s ease;
    opacity: 0;
    transform: translateX(-0.5rem);
    flex-shrink: 0;
  }

  .page-card:hover .page-card-arrow {
    opacity: 1;
    transform: translateX(0);
    color: var(--sl-color-accent);
  }

  /* ===== Related Tags Section ===== */
  .related-tags {
    padding: 1.25rem;
    background: var(--sl-color-bg-nav);
    border-radius: 0.75rem;
    border: 1px solid var(--sl-color-hairline);
  }

  .related-tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: flex-start;
    align-items: center;
  }

  /* Cloud Tag Styles */
  .cloud-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--sl-color-bg-sidebar);
    border-radius: 2rem;
    border: 1px solid var(--sl-color-hairline);
    text-decoration: none !important;
    color: var(--sl-color-text);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .cloud-tag:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow:
      0 10px 20px -5px rgba(0, 0, 0, 0.15),
      0 4px 6px -2px rgba(0, 0, 0, 0.1);
    border-color: var(--tag-accent);
    text-decoration: none !important;
  }

  .cloud-tag:focus {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .cloud-tag:active {
    transform: translateY(-1px) scale(1.02);
  }

  /* Cloud Tag - Popularity Tiers */
  .cloud-tag.tier-1 {
    font-size: 0.8rem;
    padding: 0.35rem 0.75rem;
  }

  .cloud-tag.tier-2 {
    font-size: 0.9rem;
    padding: 0.4rem 0.85rem;
  }

  .cloud-tag.tier-3 {
    font-size: 1rem;
    padding: 0.5rem 1rem;
  }

  .cloud-tag.tier-4 {
    font-size: 1.1rem;
    padding: 0.55rem 1.1rem;
    font-weight: 500;
  }

  .cloud-tag.tier-5 {
    font-size: 1.25rem;
    padding: 0.6rem 1.25rem;
    font-weight: 600;
  }

  /* Cloud Tag - Color coding */
  .cloud-tag.tier-1 { --tag-accent: #6b7280; }
  .cloud-tag.tier-2 { --tag-accent: #3b82f6; }
  .cloud-tag.tier-3 { --tag-accent: #8b5cf6; }
  .cloud-tag.tier-4 { --tag-accent: #ec4899; }
  .cloud-tag.tier-5 { --tag-accent: #f59e0b; }

  .tag-icon {
    font-style: normal;
    line-height: 1;
  }

  .tag-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5em;
    padding: 0.15em 0.5em;
    font-size: 0.75em;
    font-weight: 600;
    background: var(--tag-accent, var(--sl-color-accent));
    color: white;
    border-radius: 1rem;
    line-height: 1;
  }

  /* ===== Responsive Adjustments ===== */
  @container (max-width: 640px) {
    .tag-header-content {
      flex-direction: column;
      align-items: flex-start;
    }

    .tag-stats {
      margin-left: 0;
    }

    .pages-grid {
      grid-template-columns: 1fr;
    }

    .related-tags-cloud {
      gap: 0.5rem;
    }
  }

  /* ===== Dark Mode Refinements ===== */
  :global([data-theme='dark']) .tag-header {
    background: rgba(20, 20, 30, 0.6);
  }

  :global([data-theme='dark']) .page-card,
  :global([data-theme='dark']) .cloud-tag {
    background: rgba(30, 30, 40, 0.6);
  }

  :global([data-theme='dark']) .page-card:hover,
  :global([data-theme='dark']) .cloud-tag:hover {
    background: rgba(40, 40, 55, 0.8);
  }

  :global([data-theme='dark']) .tagged-pages,
  :global([data-theme='dark']) .related-tags {
    background: rgba(20, 20, 30, 0.5);
  }

  /* ===== Accessibility: Reduced Motion ===== */
  @media (prefers-reduced-motion: reduce) {
    .page-card,
    .page-card-arrow,
    .page-card::before,
    .cloud-tag {
      transition: none;
    }

    .page-card:hover,
    .cloud-tag:hover {
      transform: none;
    }

    .page-card:hover .page-card-arrow {
      transform: none;
    }
  }
</style>
